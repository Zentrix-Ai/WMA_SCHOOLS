<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WMA ‚Äî Meriete Aand Manager</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* ========== YOUR ORIGINAL LOOK & FEEL (kept) ========== */
    * { box-sizing: border-box; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
    body { margin:0; height:100vh; background: linear-gradient(180deg,#071326,#04101b); color:#e6eef8; display:flex; flex-direction:column;}
    .topbar { display:flex; align-items:center; justify-content:space-between; padding:14px 18px; background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); box-shadow: 0 6px 18px rgba(2,6,23,0.6); border-bottom:1px solid rgba(255,255,255,0.03); }
    .brand { display:flex; align-items:center; gap:12px; }
    .logo-3d { width:64px; height:64px; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:20px; color:#071224;
      background: linear-gradient(145deg,#7ee7c8,#7aaeff); border-radius:12px; box-shadow: 0 14px 36px rgba(96,165,250,0.12), inset 0 -6px 12px rgba(255,255,255,0.06);
      transform: perspective(800px) rotateX(8deg) rotateY(-8deg); transition: transform .18s ease;}
    .logo-3d:hover { transform: perspective(800px) rotateX(12deg) rotateY(-12deg) translateY(-4px); }
    .title { font-size:16px; letter-spacing:0.3px; color:#dff4ff; }

    /* ========== Toolbar (unchanged layout, 3D buttons added) ========== */
    .toolbar { display:flex; align-items:center; gap:8px; }
    .toolbar button {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      color:#dff4ff;
      border:1px solid rgba(255,255,255,0.03);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(2,6,23,0.5); 
      transition: transform .12s, box-shadow .12s;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      width:76px; height:74px;
    }
    .toolbar button:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 18px 34px rgba(2,6,23,0.6); }
    .toolbar button:active { transform: translateY(0px) scale(0.99); box-shadow: inset 0 6px 16px rgba(2,6,23,0.6); }
    .toolbar .ico { font-size:22px; line-height:1; }
    .toolbar .lbl { font-size:11px; margin-top:6px; color:#cfe9ff; letter-spacing:.2px; }

    .spacer { width:14px; }
    .separator { width:1px; height:36px; background:rgba(255,255,255,0.03); margin:0 8px; }
    .main-area { display:flex; gap:18px; padding:18px; height: calc(100vh - 160px); }
    .grid-wrap { flex:1; background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01)); border-radius:12px; padding:14px; box-shadow:0 10px 30px rgba(2,6,23,0.6); overflow:auto; }
    .right-panel { width:340px; display:flex; flex-direction:column; gap:14px; }
    .styled-grid { width:100%; border-collapse:collapse; background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01)); border-radius:8px; overflow:hidden; }
    .styled-grid thead th { text-align:left; padding:12px 10px; font-weight:700; font-size:13px; color:#bbdefb; border-bottom:1px solid rgba(255,255,255,0.03); position:sticky; top:0; backdrop-filter: blur(6px); }
    .styled-grid tbody td { padding:10px; border-bottom:1px dashed rgba(255,255,255,0.02); font-size:14px; color:#e6f6ff; }
    .styled-grid tbody tr:hover { background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); transform: translateZ(0); }
    .styled-grid tbody tr.selected { outline:2px solid rgba(122,170,255,0.12); background: linear-gradient(180deg, rgba(122,170,255,0.03), rgba(122,170,255,0.01)); }
    .card { padding:14px; border-radius:12px; box-shadow:0 10px 30px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); }
    .glass { backdrop-filter: blur(6px); }
    .modal { display:none; position:fixed; inset:0; align-items:center; justify-content:center; background: rgba(2,6,23,0.55); z-index:50; }
    .modal .modal-content { background: linear-gradient(180deg,#071224,#0f1b2a); color:#e6f6ff; padding:18px; width:820px; border-radius:12px; box-shadow:0 26px 80px rgba(2,6,23,0.9); border:1px solid rgba(255,255,255,0.03); }
    .modal .modal-content.small { width:520px; }
    .modal .modal-content.tiny { width:360px; }
    .form-row { display:flex; gap:12px; align-items:center; margin:8px 0; }
    .form-row label { width:110px; color:#9fc7e8; }
    .form-row input, .form-row select, .search-input, .form-row textarea { flex:1; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background: rgba(255,255,255,0.01); color:#e6f6ff; }
    .tabs { margin-top:12px; display:grid; grid-template-columns: 220px 1fr; gap:12px; height:420px; }
    .tab-buttons { display:flex; flex-direction:column; gap:8px; overflow:auto; padding-right:6px; }
    .tab-buttons button { text-align:left; padding:10px 12px; border-radius:10px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); color:#d8f0ff; border:1px solid rgba(255,255,255,0.02); cursor:pointer; box-shadow:0 8px 24px rgba(2,6,23,0.6); transition: transform .12s; }
    .tab-buttons button.active { background: linear-gradient(180deg,#5cc6a7,#77abff); color:#031428; transform: translateX(6px) scale(1.01); }
    .tab-panel { padding:8px; border-radius:10px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.0)); overflow:auto; display:flex; flex-direction:column; gap:10px; }
    .abbr-search { display:flex; gap:8px; align-items:center; }
    .abbr-list { display:block; overflow:auto; flex:1; padding:6px; border-radius:8px; border:1px dashed rgba(255,255,255,0.02); background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.0)); }
    .abbr-item { padding:8px; margin-bottom:6px; border-radius:8px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; box-shadow:0 6px 16px rgba(0,0,0,0.4); transition: transform .12s, box-shadow .12s; }
    .abbr-item:hover { transform: translateY(-4px); box-shadow: 0 18px 40px rgba(2,6,23,0.6); }
    .abbr-code { font-size:12px; padding:4px 8px; border-radius:6px; background: rgba(255,255,255,0.02); color:#bfe8ff; }
    .selected-tags { min-height:56px; display:flex; gap:6px; flex-wrap:wrap; padding:6px; border-radius:8px; border:1px dashed rgba(255,255,255,0.02); background: rgba(255,255,255,0.005); }
    .tag { padding:6px 8px; background: rgba(122,170,255,0.08); border-radius:8px; color:#dff4ff; font-size:13px; display:flex; gap:8px; align-items:center; }
    .tag .x { cursor:pointer; opacity:.8; }
    .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    .view-body { white-space:pre-wrap; padding:12px; background: rgba(255,255,255,0.01); border-radius:8px; }
    .abbr-list-compact { max-height:220px; overflow:auto; font-size:13px; }
    .abbr-list-compact .abbr-row { display:flex; justify-content:space-between; padding:6px 4px; border-bottom:1px dashed rgba(255,255,255,0.02); }
    .hidden { display:none !important; }
    .footer { padding:8px 16px; text-align:center; color:#9fbbe0; opacity:0.7; }
    button { cursor:pointer; border-radius:8px; padding:8px 10px; border:none; background: rgba(255,255,255,0.02); color:#dff4ff; }
    button.primary { background: linear-gradient(90deg,#5cc6a7,#77abff); color:#031428; }
    small { color:#9fbbe0; }

    /* Small helper to right-panel Abbr actions */
    .card .row-actions { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;}
    .card .row-actions button { padding:6px 8px; font-size:12px; }
  </style>
</head>
<body>
  <div id="app">
    <header class="topbar">
      <div class="brand">
        <div class="logo-3d">WMA</div>
        <div class="title">Meriete Aand ‚Äî Manager</div>
      </div>

      <nav class="toolbar">
        <button id="btnNew" title="New project"><span class="ico">üÜï</span><span class="lbl">New</span></button>
        <button id="btnOpen" title="Open project"><span class="ico">üìÇ</span><span class="lbl">Open</span></button>
        <button id="btnSave" title="Save project"><span class="ico">üíæ</span><span class="lbl">Save</span></button>
        <button id="btnPrint" title="Print"><span class="ico">üñ®Ô∏è</span><span class="lbl">Print</span></button>
        <div class="spacer"></div>
        <button id="btnAdd"><span class="ico">‚ûï</span><span class="lbl">Add</span></button>
        <button id="btnEdit"><span class="ico">‚úèÔ∏è</span><span class="lbl">Edit</span></button>
        <button id="btnDelete"><span class="ico">üóëÔ∏è</span><span class="lbl">Delete</span></button>
        <button id="btnReset"><span class="ico">‚ôªÔ∏è</span><span class="lbl">Reset</span></button>
        <div class="separator"></div>
        <button id="btnSearch"><span class="ico">üîé</span><span class="lbl">Search</span></button>
        <button id="btnSort"><span class="ico">üîÄ</span><span class="lbl">Sort</span></button>
        <button id="btnView"><span class="ico">üëÅÔ∏è</span><span class="lbl">View</span></button>
      </nav>
    </header>

    <main class="main-area">
      <section class="grid-wrap">
        <table id="mainGrid" class="styled-grid">
          <thead>
            <tr>
              <th>No</th>
              <th>Name</th>
              <th>Surname</th>
              <th>Points</th>
              <th>Group</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <aside class="right-panel">
        <div class="card glass">
          <h3>Project</h3>
          <p>Grade: <span id="metaGrade">‚Äî</span></p>
          <p>Dates: <span id="metaDates">‚Äî</span></p>
          <p>Rows: <span id="rowCount">0</span></p>
          <p>Selected: <span id="selectedIndex">‚Äî</span></p>
        </div>

        <div class="card glass">
          <h3>Abbreviations</h3>
          <div id="abbrList" class="abbr-list-compact">Loading‚Ä¶</div>
          <div class="row-actions">
            <button id="btnLoadAbbr" title="Load abbreviations from file">Load file</button>
            <button id="btnPasteAbbr" title="Paste JSON">Paste JSON</button>
          </div>
        </div>
      </aside>
    </main>

    <!-- Add/Edit Modal -->
    <div class="modal" id="modalAdd">
      <div class="modal-content add-3d">
        <h2 id="modalTitle">Add Person</h2>
        <div class="form-row">
          <label>Name</label>
          <input id="inpName" />
        </div>
        <div class="form-row">
          <label>Surname</label>
          <input id="inpSurname" />
        </div>

        <div class="tabs" id="abbrTabs">
          <div class="tab-buttons" id="categoryButtons"></div>

          <div class="tab-panel">
            <div class="abbr-search">
              <input id="abbrSearch" class="search-input" placeholder="Search abbreviations‚Ä¶" />
              <button id="abbrClear">Clear</button>
            </div>

            <div class="abbr-list" id="abbrListPanel"></div>

            <div>
              <h4>Selected for category: <span id="currentCategoryLabel">‚Äî</span></h4>
              <div class="selected-tags" id="selectedTags"></div>
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button id="modalOk" class="primary">OK</button>
          <button id="modalCancel">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Search Modal -->
    <div class="modal" id="modalSearch">
      <div class="modal-content small">
        <h2>Search</h2>
        <div class="form-row">
          <label>Name</label>
          <input id="searchName" />
        </div>
        <div class="form-row">
          <label>Surname</label>
          <input id="searchSurname" />
        </div>
        <div class="modal-actions">
          <button id="searchApply" class="primary">Find</button>
          <button id="searchCancel">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Sort Modal -->
    <div class="modal" id="modalSort">
      <div class="modal-content tiny">
        <h2>Sort</h2>
        <div class="form-row"><label><input type="radio" name="sort" value="0"> Name A‚ÜíZ</label></div>
        <div class="form-row"><label><input type="radio" name="sort" value="1"> Name Z‚ÜíA</label></div>
        <div class="form-row"><label><input type="radio" name="sort" value="2"> Surname A‚ÜíZ</label></div>
        <div class="form-row"><label><input type="radio" name="sort" value="3"> Surname Z‚ÜíA</label></div>
        <div class="form-row"><label><input type="radio" name="sort" value="4"> Points ‚Üì</label></div>
        <div class="form-row"><label><input type="radio" name="sort" value="5"> Points ‚Üë</label></div>
        <div class="modal-actions">
          <button id="sortApply" class="primary">Sort</button>
          <button id="sortCancel">Cancel</button>
        </div>
      </div>
    </div>

    <!-- View Modal -->
    <div class="modal" id="modalView">
      <div class="modal-content">
        <h2 id="viewHeader">Person</h2>
        <pre id="viewBody" class="view-body"></pre>
        <div class="modal-actions">
          <button id="viewClose">Close</button>
        </div>
      </div>
    </div>

    <!-- New workflow: grade and dates -->
    <div class="modal" id="modalGrade">
      <div class="modal-content tiny">
        <h2>Select Grade</h2>
        <select id="gradeSelect">
          <option value="8">Grade 8</option>
          <option value="9">Grade 9</option>
          <option value="10">Grade 10</option>
          <option value="11">Grade 11</option>
          <option value="12">Grade 12</option>
        </select>
        <div class="modal-actions">
          <button id="gradeOk" class="primary">OK</button>
        </div>
      </div>
    </div>

    <div class="modal" id="modalDates">
      <div class="modal-content tiny">
        <h2>Event Dates</h2>
        <div class="form-row"><label>Evening 1</label><input type="date" id="date1" /></div>
        <div class="form-row"><label>Evening 2</label><input type="date" id="date2" /></div>
        <div class="modal-actions">
          <button id="datesOk" class="primary">OK</button>
        </div>
      </div>
    </div>

    <!-- Abbreviation Loader Modal -->
    <div class="modal" id="modalAbbr">
      <div class="modal-content small">
        <h2>Load Abbreviations</h2>
        <div class="form-row">
          <label>From File</label>
          <input type="file" id="abbrFileInput" accept=".json,application/json" />
        </div>
        <div class="form-row" style="align-items:flex-start;">
          <label>Or Paste JSON</label>
          <textarea id="abbrPaste" rows="8" placeholder='[{"code":"X1","label":"Example","categoryId":"Kleure"}]'></textarea>
        </div>
        <div class="modal-actions">
          <button id="abbrPasteApply" class="primary">Use Pasted JSON</button>
          <button id="abbrClose">Close</button>
        </div>
      </div>
    </div>

    <footer class="footer"><small>Divan Barnard ‚Äî WMA</small></footer>
  </div>

  <!-- hidden file input for OPEN project -->
  <input type="file" id="openFileInput" accept=".json,application/json" class="hidden" />

  <script>
    // ===== Category config (kept) =====
    const CATEGORIES = [
      { id: 'Verdienstelik', label: 'Verdienstelik', weight: 1, group: 'Verdienstelik', priority: 1 },
      { id: 'Kleure', label: 'Kleure', weight: 4, group: 'Kleure', priority: 2 },
      { id: 'Erekleure', label: 'Erekleure', weight: 12, group: 'Erekleure', priority: 3 },
      { id: 'Trofee', label: 'Trofee', weight: 7, group: 'Erekleure', priority: 3 },
      { id: 'Penning', label: 'Penning', weight: 22, group: 'Erekleure', priority: 3 },
      { id: 'VakBo90', label: 'Vak bo 90%', weight: 2, group: 'Verdienstelik', priority: 1 },
      { id: 'VakPrestasie', label: 'Vak prestasie', weight: 6, group: 'Erekleure', priority: 3 },
      { id: 'SpesialeSert', label: 'Spesiale sertifikaat', weight: 3, group: 'Erekleure', priority: 3 },
      { id: 'Top20', label: 'Top 20', weight: 5, group: 'Kleure', priority: 2 }
    ];
   


    // ===== State =====
    let project = { meta: { grade: null, eventDates: [] }, awards: [] };
    let abbreviations = []; // will load below (file/paste/fallback)
    let selectedRowIndex = -1;
    let editingIndex = -1;
    let currentCategory = CATEGORIES[0].id;
    let tempSelections = {};

    // ===== DOM =====
    const tbody = document.querySelector('#mainGrid tbody');
    const rowCountLabel = document.getElementById('rowCount');
    const metaGradeEl = document.getElementById('metaGrade');
    const metaDatesEl = document.getElementById('metaDates');
    const selectedIndexEl = document.getElementById('selectedIndex');
    const abbrListCompact = document.getElementById('abbrList');

    // ===== Utils =====
    function computeGroupAndPoints(selections) {
      let totalPoints = 0;
      let bestPriority = -1;
      let bestGroup = '';

      CATEGORIES.forEach(cat => {
        const arr = selections[cat.id] || [];
        if (arr.length > 0) {
          totalPoints += arr.length * cat.weight;
          if (cat.priority > bestPriority) {
            bestPriority = cat.priority;
            bestGroup = cat.group;
          }
        }
      });

      return { points: totalPoints, group: bestGroup || '' };
    }

    function renderProjectMeta() {
      metaGradeEl.textContent = project.meta.grade || '‚Äî';
      metaDatesEl.textContent = (project.meta.eventDates && project.meta.eventDates.length === 2)
        ? project.meta.eventDates.join('  &  ') : '‚Äî';
    }

    function renderTable() {
      tbody.innerHTML = '';
      project.awards.forEach((person, idx) => {
        const tr = document.createElement('tr');
        if (idx === selectedRowIndex) tr.classList.add('selected');
        tr.dataset.index = idx;

        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${person.name}</td>
          <td>${person.surname}</td>
          <td>${person.points}</td>
          <td>${person.group}</td>
        `;
        tr.addEventListener('click', () => {
          selectedRowIndex = idx;
          selectedIndexEl.textContent = (idx + 1);
          Array.from(tbody.querySelectorAll('tr')).forEach(r => r.classList.remove('selected'));
          tr.classList.add('selected');
        });
        tbody.appendChild(tr);
      });
      rowCountLabel.textContent = project.awards.length;
    }

    function downloadJSON(filename, dataObj) {
      const blob = new Blob([JSON.stringify(dataObj, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);
      a.remove();
    }

    // ===== Abbreviation UI (right panel compact list) =====
    function renderAbbreviationsCompact() {
      abbrListCompact.innerHTML = '';
      if (!abbreviations || abbreviations.length === 0) {
        abbrListCompact.textContent = '(no abbreviations loaded)';
        return;
      }
      abbreviations.forEach(a => {
        const div = document.createElement('div');
        div.className = 'abbr-row';
        const left = document.createElement('div');
        left.textContent = a.label || a.code || a;
        const right = document.createElement('div');
        right.className = 'abbr-code';
        right.textContent = a.code || a;
        div.appendChild(left); div.appendChild(right);
        abbrListCompact.appendChild(div);
      });
    }

    // ===== Add/Edit Modal ‚Äî Abbreviation selection =====
    function buildCategoryButtons() {
      const wrap = document.getElementById('categoryButtons');
      wrap.innerHTML = '';
      CATEGORIES.forEach(cat => {
        const b = document.createElement('button');
        b.textContent = cat.label;
        if (cat.id === currentCategory) b.classList.add('active');
        b.addEventListener('click', () => {
          currentCategory = cat.id;
          Array.from(wrap.children).forEach(c => c.classList.remove('active'));
          b.classList.add('active');
          document.getElementById('currentCategoryLabel').textContent = cat.label;
          renderAbbrPanel();
          renderSelectedTags();
        });
        wrap.appendChild(b);
      });
      document.getElementById('currentCategoryLabel').textContent =
        CATEGORIES.find(c => c.id === currentCategory)?.label || '‚Äî';
    }

    function renderAbbrPanel() {
      const panel = document.getElementById('abbrListPanel');
      const q = (document.getElementById('abbrSearch').value || '').toLowerCase();
      const list = abbreviations.filter(a =>
        a.categoryId === currentCategory &&
        ((a.label || '').toLowerCase().includes(q) || (a.code || '').toLowerCase().includes(q))
      );
      panel.innerHTML = '';
      list.forEach(item => {
        const row = document.createElement('div');
        row.className = 'abbr-item';
        row.innerHTML = `
          <div>${item.label || item.code}</div>
          <div class="abbr-code">${item.code}</div>
        `;
        row.addEventListener('click', () => toggleSelection(item.code));
        panel.appendChild(row);
      });
    }

    function renderSelectedTags() {
      const box = document.getElementById('selectedTags');
      box.innerHTML = '';
      const arr = tempSelections[currentCategory] || [];
      arr.forEach(code => {
        const ab = abbreviations.find(a => a.code === code);
        const tag = document.createElement('div');
        tag.className = 'tag';
        tag.innerHTML = `<span>${ab ? ab.label : code}</span> <span class="x">‚úï</span>`;
        tag.querySelector('.x').addEventListener('click', () => removeSelection(code));
        box.appendChild(tag);
      });
    }

    function toggleSelection(code) {
      tempSelections[currentCategory] = tempSelections[currentCategory] || [];
      const arr = tempSelections[currentCategory];
      const i = arr.indexOf(code);
      if (i >= 0) arr.splice(i, 1); else arr.push(code);
      renderSelectedTags();
    }
    function removeSelection(code) {
      tempSelections[currentCategory] = tempSelections[currentCategory] || [];
      const arr = tempSelections[currentCategory];
      const i = arr.indexOf(code);
      if (i >= 0) arr.splice(i, 1);
      renderSelectedTags();
    }

    // ===== Modals =====
    function showModal(id) { document.getElementById(id).style.display = 'flex'; }
    function hideModal(id) { document.getElementById(id).style.display = 'none'; }

    // ===== Button handlers =====
    function setupButtonListeners() {
      // New project
      document.getElementById('btnNew').addEventListener('click', () => {
        if (!confirm('Start a new project? Unsaved changes will be lost.')) return;
        project = { meta: { grade: null, eventDates: [] }, awards: [] };
        editingIndex = -1; selectedRowIndex = -1;
        renderProjectMeta(); renderTable();
        showModal('modalGrade');
      });

      // Open project (from file)
      document.getElementById('btnOpen').addEventListener('click', () => {
        document.getElementById('openFileInput').value = '';
        document.getElementById('openFileInput').click();
      });
      document.getElementById('openFileInput').addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        try {
          const text = await file.text();
          const data = JSON.parse(text);
          if (!data || !Array.isArray(data.awards)) throw new Error('Invalid project file');
          project = data;
          selectedRowIndex = -1; editingIndex = -1;
          renderProjectMeta(); renderTable();
          alert('Project loaded.');
        } catch (err) {
          console.error(err);
          alert('Failed to open project JSON.');
        }
      });

      // Save project (download JSON)
      document.getElementById('btnSave').addEventListener('click', () => {
        const gradeSlug = (project.meta.grade || 'grade').replace(/\s+/g,'');
        downloadJSON(`WMA_${gradeSlug}.json`, project);
        alert('Saved (downloaded).');
      });

      // Print
      document.getElementById('btnPrint').addEventListener('click', () => window.print());

      // Add
      document.getElementById('btnAdd').addEventListener('click', () => {
        editingIndex = -1;
        document.getElementById('modalTitle').textContent = 'Add Person';
        document.getElementById('inpName').value = '';
        document.getElementById('inpSurname').value = '';
        tempSelections = {};
        currentCategory = CATEGORIES[0].id;
        buildCategoryButtons();
        document.getElementById('abbrSearch').value = '';
        renderAbbrPanel(); renderSelectedTags();
        showModal('modalAdd');
      });

      // Edit
      document.getElementById('btnEdit').addEventListener('click', () => {
        if (selectedRowIndex < 0 || selectedRowIndex >= project.awards.length) {
          alert('Select a row to edit'); return;
        }
        editingIndex = selectedRowIndex;
        const p = project.awards[editingIndex];
        document.getElementById('modalTitle').textContent = 'Edit Person';
        document.getElementById('inpName').value = p.name;
        document.getElementById('inpSurname').value = p.surname;
        tempSelections = JSON.parse(JSON.stringify(p.selections || {}));
        currentCategory = CATEGORIES[0].id;
        buildCategoryButtons();
        document.getElementById('abbrSearch').value = '';
        renderAbbrPanel(); renderSelectedTags();
        showModal('modalAdd');
      });

      // Delete
      document.getElementById('btnDelete').addEventListener('click', () => {
        if (selectedRowIndex < 0 || selectedRowIndex >= project.awards.length) {
          alert('Select a row to delete'); return;
        }
        if (!confirm('Delete selected person?')) return;
        project.awards.splice(selectedRowIndex, 1);
        selectedRowIndex = -1;
        renderTable();
      });

      // Reset
      document.getElementById('btnReset').addEventListener('click', () => {
        if (!confirm('Reset all people in the current project?')) return;
        project.awards = []; selectedRowIndex = -1;
        renderTable();
      });

      // Search
      document.getElementById('btnSearch').addEventListener('click', () => {
        document.getElementById('searchName').value = '';
        document.getElementById('searchSurname').value = '';
        showModal('modalSearch');
      });

      // Sort
      document.getElementById('btnSort').addEventListener('click', () => showModal('modalSort'));

      // View
      document.getElementById('btnView').addEventListener('click', () => {
        if (selectedRowIndex < 0 || selectedRowIndex >= project.awards.length) {
          alert('Select a row to view'); return;
        }
        const p = project.awards[selectedRowIndex];
        const lines = [];
        lines.push(`Name: ${p.name} ${p.surname}`);
        lines.push(`Points: ${p.points}`);
        lines.push(`Group: ${p.group}`);
        lines.push('');
        lines.push('Achievements:');
        CATEGORIES.forEach(cat => {
          const arr = (p.selections||{})[cat.id] || [];
          if (arr.length) {
            lines.push(`-- ${cat.label} --`);
            arr.forEach(code => {
              const ab = abbreviations.find(a => a.code === code);
              lines.push(`  ${(ab ? ab.label : code)} (${code})`);
            });
            lines.push('');
          }
        });
        document.getElementById('viewBody').textContent = lines.join('\n');
        showModal('modalView');
      });

      // Modal: grade/dates
      document.getElementById('gradeOk').addEventListener('click', () => {
        const val = document.getElementById('gradeSelect').value;
        project.meta.grade = `Grade ${val}`;
        hideModal('modalGrade');
        showModal('modalDates');
      });
      document.getElementById('datesOk').addEventListener('click', () => {
        const d1 = document.getElementById('date1').value;
        const d2 = document.getElementById('date2').value;
        project.meta.eventDates = [d1, d2];
        renderProjectMeta();
        hideModal('modalDates');
      });

      // Modal: Add person OK/Cancel
      document.getElementById('modalOk').addEventListener('click', () => {
        const name = document.getElementById('inpName').value.trim();
        const surname = document.getElementById('inpSurname').value.trim();
        if (!name || !surname) { alert('Enter name and surname'); return; }
        CATEGORIES.forEach(c => tempSelections[c.id] = tempSelections[c.id] || []);
        const { points, group } = computeGroupAndPoints(tempSelections);
        const person = { name, surname, selections: JSON.parse(JSON.stringify(tempSelections)), points, group };
        if (editingIndex >= 0) project.awards[editingIndex] = person; else project.awards.push(person);
        hideModal('modalAdd');
        renderTable();
      });
      document.getElementById('modalCancel').addEventListener('click', () => hideModal('modalAdd'));

      // Modal: View close
      document.getElementById('viewClose').addEventListener('click', () => hideModal('modalView'));

      // Modal: Search apply/cancel
      document.getElementById('searchApply').addEventListener('click', () => {
        const name = document.getElementById('searchName').value.trim().toLowerCase();
        const surname = document.getElementById('searchSurname').value.trim().toLowerCase();
        let foundIndex = -1;
        for (let i = 0; i < project.awards.length; i++) {
          const p = project.awards[i];
          const matchName = !name || p.name.toLowerCase().includes(name);
          const matchSurname = !surname || p.surname.toLowerCase().includes(surname);
          if (matchName && matchSurname) { foundIndex = i; break; }
        }
        if (foundIndex === -1) alert('No match found.');
        else {
          selectedRowIndex = foundIndex;
          renderTable();
          const row = tbody.querySelector(`tr[data-index="${foundIndex}"]`);
          if (row) row.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        hideModal('modalSearch');
      });
      document.getElementById('searchCancel').addEventListener('click', () => hideModal('modalSearch'));

      // Modal: Sort apply/cancel
      document.getElementById('sortApply').addEventListener('click', () => {
        const sel = document.querySelector('input[name="sort"]:checked');
        if (!sel) { alert('Choose a sort option'); return; }
        const val = Number(sel.value);
        switch (val) {
          case 0: project.awards.sort((a,b)=>a.name.localeCompare(b.name)); break;
          case 1: project.awards.sort((a,b)=>b.name.localeCompare(a.name)); break;
          case 2: project.awards.sort((a,b)=>a.surname.localeCompare(b.surname)); break;
          case 3: project.awards.sort((a,b)=>b.surname.localeCompare(a.surname)); break;
          case 4: project.awards.sort((a,b)=>b.points - a.points); break;
          case 5: project.awards.sort((a,b)=>a.points - b.points); break;
        }
        renderTable();
        hideModal('modalSort');
      });
      document.getElementById('sortCancel').addEventListener('click', () => hideModal('modalSort'));

      // Abbreviation: search/clear within Add modal
      document.getElementById('abbrSearch').addEventListener('input', () => renderAbbrPanel());
      document.getElementById('abbrClear').addEventListener('click', () => { document.getElementById('abbrSearch').value = ''; renderAbbrPanel(); });

      // Abbreviation loader buttons (right panel)
      document.getElementById('btnLoadAbbr').addEventListener('click', () => showModal('modalAbbr'));
      document.getElementById('btnPasteAbbr').addEventListener('click', () => showModal('modalAbbr'));
      document.getElementById('abbrClose').addEventListener('click', () => hideModal('modalAbbr'));
      document.getElementById('abbrFileInput').addEventListener('change', async (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        try {
          const text = await f.text();
          const data = JSON.parse(text);
          if (!Array.isArray(data)) throw new Error('Expected an array');
          abbreviations = normalizeAbbr(data);
          renderAbbreviationsCompact();
          alert('Abbreviations loaded from file.');
          hideModal('modalAbbr');
        } catch (err) {
          console.error(err);
          alert('Invalid abbreviations JSON.');
        }
      });
      document.getElementById('abbrPasteApply').addEventListener('click', () => {
        const text = document.getElementById('abbrPaste').value.trim();
        if (!text) { alert('Paste JSON first.'); return; }
        try {
          const data = JSON.parse(text);
          if (!Array.isArray(data)) throw new Error('Expected an array');
          abbreviations = normalizeAbbr(data);
          renderAbbreviationsCompact();
          alert('Abbreviations loaded from pasted JSON.');
          hideModal('modalAbbr');
        } catch (err) {
          console.error(err);
          alert('Invalid abbreviations JSON.');
        }
      });
    }

    function normalizeAbbr(arr) {
      // Accepts shape: {code,label,categoryId} or {code,label,category} or any string "CODE - Label (Category)"
      return arr.map(x => {
        if (typeof x === 'string') {
          // Very loose parser: "CODE - Label (CategoryId)"
          const m = x.match(/^([^-\s]+)\s*-\s*(.*?)\s*\(([^)]+)\)\s*$/);
          if (m) return { code: m[1].trim(), label: m[2].trim(), categoryId: m[3].trim() };
          return { code: x.trim(), label: x.trim(), categoryId: CATEGORIES[0].id };
        }
        return {
          code: x.code ?? '',
          label: x.label ?? x.code ?? '',
          categoryId: x.categoryId ?? x.category ?? CATEGORIES[0].id
        };
      }).filter(a => a.code);
    }

    // ===== Boot =====
    function boot() {
      // Default fallback abbreviations so the UI never looks empty
      const DEFAULT_ABBRS = normalizeAbbr([
        { code: "Aeat", label: "Afrikaans Eerste Addisionele" },
{ code: "Afre", label: "Afrikaans Ekspo" },
{ code: "Ar", label: "Afrikaans Redenaars" },
{ code: "Toneel", label: "Afrikaans Toneel" },
{ code: "Aolim", label: "Afrikaanse Olimpiade" },
{ code: "Ak", label: "Akademie En Kultuur" },
{ code: "Adrt", label: "Alkantrand Rapportryers" },
{ code: "Aft", label: "Alliance Francias trofee" },
{ code: "Awis", label: "Alpha Wiskunde" },
{ code: "Abd", label: "Ambassadeurspenning" },
{ code: "Ag", label: "Artistiese Gimnastiek" },
{ code: "Atkv", label: "Atkv" },
{ code: "Blw", label: "Belowendste" },
{ code: "Belsp", label: "Belowendste Speler" },
{ code: "Bsm", label: "Belowendste Sportman" },
{ code: "Bs", label: "Belowendste Sportvrou" },
{ code: "Bem", label: "Bemarking" },
{ code: "Bf", label: "Bergfiets" },
{ code: "Bcw", label: "Best English Creative Writing" },
{ code: "Badt", label: "Beste Addisionele Taal" },
{ code: "Baks", label: "Beste Afrikaanse Kreatiewe" },
{ code: "Ba", label: "Beste Afrikaanse" },
{ code: "Bakt", label: "Beste Akteur" },
{ code: "Bak", label: "Beste Aktrise" },
{ code: "Bg12l", label: "Beste Graad 12 Lereder" },
{ code: "Bg8", label: "Beste Graad 8" },
{ code: "Bjd", label: "Beste Junior Dogter" },
{ code: "Bjs", label: "Beste Junior Seun" },
{ code: "Bepr", label: "Beste Prestasie" },
{ code: "Bp", label: "Beste Prestasie" },
{ code: "Bsd", label: "Beste Senior Dogetr" },
{ code: "Bsdar", label: "Beste Senior Dogetr Afrikaans" },
{ code: "Bse", label: "Beste Senior Ekstern" },
{ code: "Bsns", label: "Beste Senior Netbalspeler" },
{ code: "Bsoe", label: "Beste Senior Orator english" },
{ code: "Bsr", label: "Beste Senior Rugbyspeler" },
{ code: "Bss", label: "Beste Senior Seun" },
{ code: "Bstd", label: "Beste Senior Tennis Dogterspel" },
{ code: "Tegl", label: "Beste Tegniese Leerder" },
{ code: "Bv", label: "Beste Vordering" },
{ code: "Bvu", label: "Beste Vordering En Uitvoering" },
{ code: "Bw", label: "Bestuurswetenskappe" },
{ code: "Bhh", label: "Binnehuise Hokkie" },
{ code: "Bba", label: "Blou Bulle Akademiesespan" },
{ code: "Boogs", label: "Boogskutter Van Die Jaar" },
{ code: "Bat", label: "Buite Aktiwiteite" },
{ code: "Bsp", label: "Buitesport" },
{ code: "Cvz", label: "Clovilda Coetzer trofee" },
{ code: "Dp", label: "Daan Potgietertrofee" },
{ code: "Dpt", label: "Danie Pretorius trofee" },
{ code: "Dj", label: "Danser Van Die Jaar" },
{ code: "Doelw", label: "Doelwagter Van Die Jaar" },
{ code: "Dgvd", label: "Dogtersgholfspeler Van Die" },
{ code: "Ect", label: "E. Carstens trofee" },
{ code: "Egs", label: "Een Jaar Getroue Skoolbesoek" },
{ code: "Eat", label: "Eerste Addisionele Taal" },
{ code: "Ekon", label: "Ekonomie" },
{ code: "Ekon&", label: "Ekonomiese &" },
{ code: "Est", label: "Elandri Stricker Timmermans" },
{ code: "Elek", label: "Elektriese Tegnologie" },
{ code: "En", label: "Engeks" },
{ code: "Ee", label: "Engels Eerste Addisionele" },
{ code: "Efal", label: "English F A L" },
{ code: "Ehl", label: "English Home Language" },
{ code: "Ejw", label: "Expo Vir Jong Wetenskaplikes" },
{ code: "Fal", label: "First Additional Language" },
{ code: "Fwet", label: "Fisiese Wetenskappe" },
{ code: "Gnh", label: "Gauteng noord Ho√´rskoolspan" },
{ code: "Gns", label: "Gauteng noord Stadsbeker" },
{ code: "Gj", label: "Gebiedsjeugraad" },
{ code: "Gd", label: "Gemeenskapsdiens" },
{ code: "Gm", label: "Gemeenskapsdiens" },
{ code: "Ges", label: "Gesamentlik" },
{ code: "Gesps", label: "Gespesialiseerde Sport" },
{ code: "Gvdj", label: "Gholfspeler Van Die Jaar" },
{ code: "G12", label: "Graad 12" },
{ code: "Gps", label: "Grootste Puntemaker Skaak" },
{ code: "Hbds", label: "Hokkie Beste Senior Dogter" },
{ code: "Hsvdj", label: "Hokkiespeler Van Die Jaar" },
{ code: "Igo", label: "Ingenieursgrafika & Ontwerp" },
{ code: "It", label: "Inligtingstegnologie" },
{ code: "Ins", label: "Inscape trofee" },
{ code: "Id", label: "Internasionale Deelname" },
{ code: "Jvat", label: "J. Van Aswegen trofee" },
{ code: "Jdvt", label: "J.d. Vorster trofee" },
{ code: "Jjt", label: "Jacobus Jordaan trofee" },
{ code: "Jft", label: "Janet Fouch√© trofee" },
{ code: "Jdans", label: "Jazz en Kontempor√™r Dans" },
{ code: "jnr", label: "Junior" },
{ code: "Jee", label: "Junior EKsterne Eksamen" },
{ code: "Js", label: "Junior Stadsraad" },
{ code: "Kkr", label: "Klofiekanredaksie" },
{ code: "Ko", label: "Konsertorkes" },
{ code: "Ksw", label: "Kreatiewe Skryfwerk" },
{ code: "Klp", label: "Kultuurleierspenning" },
{ code: "Kuwed", label: "Kunswedstryd" },
{ code: "Km", label: "Kunswedtsryd Musiek" },
{ code: "Leer", label: "Leerder Van Die Jaar" },
{ code: "Lrr", label: "Leerderraad" },
{ code: "Ls", label: "Leierskap" },
{ code: "Lo", label: "Lewensori√´ntering" },
{ code: "Lvr", label: "Lewensverryking" },
{ code: "Lw", label: "Lewenswetenskappe" },
{ code: "Lm", label: "Ligte Musiekensemble" },
{ code: "Let", label: "Louwrens Erasmus trofee" },
{ code: "Mlrt", label: "Marlene Le Roux trofee" },
{ code: "Mart", label: "Martins trofee" },
{ code: "Mam", label: "Media Ambassadeur Van Die Jaar" },
{ code: "Mb", label: "Mees Belowende" },
{ code: "Mbkd", label: "Mees Belowende Kultuurdogter" },
{ code: "Mbs", label: "Mees Belowende Speler" },
{ code: "Mbt", label: "Mees Belowende Toneelspeler" },
{ code: "Mts", label: "Mees toegewyde Speler" },
{ code: "Mvd", label: "Mees Veelsydige Danser" },
{ code: "mveelm", label: "Mees Veelsydige Musiekleerder" },
{ code: "Ms", label: "Moraletaspruit" },
{ code: "Mus", label: "Musiek" },
{ code: "Ml", label: "Musiek & Liriek" },
{ code: "Mst", label: "Musiek Beste Stryker" },
{ code: "Mti", label: "Musiek Tweede Instrument" },
{ code: "Ma", label: "Musiekambassadeur" },
{ code: "Mlj", label: "Musiekleerder Van Die Jaar" },
{ code: "Naw", label: "Nasionale Afdelingswenner" },
{ code: "Nm", label: "Nasionale Minquiz kompetisie" },
{ code: "Nwo", label: "Nasionale Wetenskap Olimpiade" },
{ code: "Nspan", label: "d Gauteng Gholfspan" },
{ code: "Ng", label: "Noord Gauteng" },
{ code: "Nvt", label: "Noordval Trofee" },
{ code: "Nptr", label: "Nupower/TUKS Reeks Wenner" },
{ code: "Od", label: "Onderhoofdogter" },
{ code: "Oh", label: "Onderhoofseun" },
{ code: "Owh", label: "Onderwater hokkie" },
{ code: "Pvdmt", label: "P.v.d.m. Martins trofee" },
{ code: "Pgt", label: "Paul Groenewald trofee" },
{ code: "Pk", label: "Pecanwood Kollege" },
{ code: "Pvr", label: "Piet Van Rensburgtrofee" },
{ code: "Prak", label: "Prakties" },
{ code: "Pres", label: "Presidentsverkenner" },
{ code: "Ptae", label: "Pretoria Eisteddfod" },
{ code: "Ra", label: "Rapportryers Alkantrand" },
{ code: "Rd", label: "Redenaar" },
{ code: "Rtt", label: "Rekenaartoepassingstegnologie" },
{ code: "Rst", label: "Rona Schoeman trofee" },
{ code: "Svtt", label: "S. van Tonder trofee" },
{ code: "St", label: "Saambou trofee" },
{ code: "Sek", label: "Sekretaris" },
{ code: "Sr", label: "Senior" },
{ code: "Sem", label: "Senior Eksterne Musiekeksamen" },
{ code: "Svi", label: "Senior Victor Ludorum" },
{ code: "Svl", label: "Senior Victrix Ludorem" },
{ code: "Sgvdj", label: "Seunsgholfspeler Van Die Jaar" },
{ code: "Siv", label: "Siviele" },
{ code: "Svj", label: "Skaakspeler Van Die Jaar" },
{ code: "Skep", label: "Skeppende Kunste" },
{ code: "Skr", label: "Skryfwerk" },
{ code: "Sjc", label: "Snr. Jazz & Contemporary" },
{ code: "Sos", label: "Sosiaal" },
{ code: "Sp", label: "Sport" },
{ code: "So", label: "Sport & Oefenkunde" },
{ code: "Sot", label: "Sport & Oefenkunde trofee" },
{ code: "Smvdj", label: "Sportman Van Die Jaar" },
{ code: "Svvdj", label: "Sportvrou Van Die Jaar" },
{ code: "Sd", label: "Spraak En Drama" },
{ code: "Sa", label: "Suid Afrika" },
{ code: "Teg", label: "Tegnologie" },
{ code: "Treg", label: "Toneel Regisseursassistent" },
{ code: "Topp", label: "Toppresteerder" },
{ code: "Tdkt", label: "Toppresteerder In Dramatiese KT" },
{ code: "Tett", label: "Toppresteerder In Elektries TTett" },
{ code: "Igot", label: "Toppresteerder In IngenieursgrIgot" },
{ code: "Trof", label: "Trofee" },
{ code: "Trom", label: "Trompoppies" },
{ code: "Vbo", label: "Vak Bo 90%" },
{ code: "Vdht", label: "Van Der Hoven trofee" },
{ code: "Vdwt", label: "Van Der Westhuizen trofee" },
{ code: "Vhr", label: "Van Huyssteens Redenaars" },
{ code: "Vm", label: "Veelsydige Musiekleerder" },
{ code: "Ver", label: "Verteenwoordigende" },
{ code: "Vk", label: "Visuele Kunste" },
{ code: "Vs", label: "Voorsitter" },
{ code: "Wvt", label: "Wenner Voorsitterstrofee" },
{ code: "Wrek", label: "Wiskunde & Rekeningkunde" },
{ code: "Ws", label: "Wiskunde Skolespan" },
{ code: "Wvra", label: "Wiskunde Vraestel 3" },
{ code: "Wgl", label: "Wiskundige Geletterdheid" },
      ]);
      abbreviations = DEFAULT_ABBRS;

      renderAbbreviationsCompact();
      renderProjectMeta();
      renderTable();
      setupButtonListeners();
    }

    // Start
    boot();
  </script>
</body>
</html>



